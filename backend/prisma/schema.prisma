generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum CurrencyType {
  NGN
  USDT
  BTC
  ETH
  BNB
  TRX
}

enum TransactionType {
  FUNDING // user pay into their account
  PAYOUT // user withdraw money to an external account - bank/crypto wallet
  TRANSFER // internal transfer from one wallet type to another or from one user to another
  PAYMENT // using wallet balance to pay for a service or 
}

enum TransactionStaus {
  PENDING // waiting for confirmation - crypto confirmation/bank approval
  COMPLETED
  FAILED
  REVERSED // payment was undone after completion
}

enum TransferAction {
  WITHDRAW
  DEPOSIT
  TRANSFER
}

enum WalletStatus {
  ACTIVE
  FROZEN
}

model rates {
  id                 String   @id @default(uuid())
  currency_from      String   @db.VarChar(20)
  currency_to        String   @db.VarChar(20)
  current_rate       Decimal  @db.Decimal(18, 4)
  merchant_rate      Decimal  @db.Decimal(18, 4)
  profit_rate        Decimal? @default(dbgenerated()) @ignore @db.Decimal(18, 4)
  current_rate_used  Decimal? @db.Decimal(18, 4)
  merchant_rate_used Decimal? @db.Decimal(18, 4)
  profit_rate_used   Decimal? @db.Decimal(18, 4)
  updated_at         DateTime @default(now()) @db.Timestamp(6)
}

model transactions {
  id               String           @id @default(uuid())
  wallet_id        String
  amount           Decimal          @db.Decimal(18, 7)
  type             CurrencyType
  status           TransactionStaus @default(PENDING)
  action           TransferAction
  previous_balance Decimal          @db.Decimal(18, 7)
  new_balance      Decimal          @db.Decimal(18, 7)
  reference        String           @unique @db.VarChar(100)
  metadata         Json?
  created_at       DateTime         @default(now()) @db.Timestamp(6)
  wallets          wallets          @relation(fields: [wallet_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([reference], map: "idx_tx_reference")
  @@index([status], map: "idx_tx_status")
  @@index([type], map: "idx_tx_type")
  @@index([wallet_id], map: "idx_tx_wallet")
}

model users {
  id             String           @id @default(uuid())
  first_name     String           @db.VarChar(100)
  last_name      String           @db.VarChar(100)
  user_name      String           @unique @db.VarChar(50)
  account_number String?          @db.VarChar(10)
  email          String           @unique @db.VarChar(255)
  phone          String           @unique @db.VarChar(50)
  password_hash  String
  kyc_status     String           @default("unverified") @db.VarChar(50)
  created_at     DateTime         @default(now()) @db.Timestamp(6)
  wallets        wallets[]
  tokens         refresh_tokens[]
}

model wallets {
  id             String         @id @default(uuid())
  user_id        String
  balance        Decimal        @default(0.00) @db.Decimal(18, 7)
  currency       String         @db.VarChar(20)
  type           CurrencyType
  wallet_address String?        @unique @db.VarChar(100)
  status         WalletStatus   @default(ACTIVE)
  created_at     DateTime       @default(now()) @db.Timestamp(6)
  transactions   transactions[]
  users          users          @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, type])
  @@index([currency], map: "idx_wallet_currency")
  @@index([user_id], map: "idx_wallet_user")
}

model refresh_tokens {
  id                String   @id @default(uuid())
  user_id           String
  token             String   @db.VarChar(255)
  is_revoked        Boolean  @default(false)
  created_at        DateTime @default(now()) @db.Timestamp(6)
  expires_at        DateTime
  replaced_by_token String?
  users             users    @relation(fields: [user_id], references: [id])

  @@index([token], map: "idx_token_tokens")
}
